<!DOCTYPE html>
<html>
	<head>
	
		<title>StackOverflow Favorites Organizer</title>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.13.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
		<link type="text/css" rel="Stylesheet" href="http://infinity88.com/stackunderflow/stackoverflow.min.css" />
		<script type="text/javascript" src="http://infinity88.com/stackunderflow/stackunderflow-1.0.3.min.js"></script>
		
		<script type="text/javascript">
			var allFavorites = {};
			var tags = {};
			var userID;
			
			$(document).ready(function () {
				$('#userIDForm').submit(function() {
					userID = $('#userID').val();
					
					getFavoriteQuestions();
					
					return false;
				});

				$('#searchForm').submit(function() {
					performSearch();
					
					return false;
				});				
			
				$( "#tabs" ).tabs();
			
				$('.expand').live('click', function(event) {
					var $expandLink = $(this);
					
					$(this).next().toggle('fast', function() {
						
						if($expandLink.text() == '+') {
							$expandLink.html('&minus;');
							$expandLink.addClass('red');
						} else {
							$expandLink.text('+');
							$expandLink.removeClass('red');
						}
					});
					
					event.stopPropagation();
					event.preventDefault();
				});
				
				$('.questionContent').hide();
			
				$('#folders').sortable();
				
			});
			
		function getFavoriteQuestions() {
			//Reset various elements on the page
			allFavorites = {};
			tags = {};
			$('#allFavorites').html('');
			$('#folders').html('');
			$('#searchResults').html('');
			$('#userFlair').html('');
		
			var flairHtml = '<a href="http://stackoverflow.com/users/'+userID+'/"><img src="http://stackoverflow.com/users/flair/'+userID+'.png"></a>';
			$('#userFlair').html(flairHtml);
			
				
			$.getJSON('http://api.stackoverflow.com/1.1/users/'+userID+'/favorites?jsonp=?',
				{
					pagesize: '100'
				},
				function(data) {
		
					$.each(data.questions, function(index, question) {
						// The text values returned from the api are not encoded with the
						// HTML entities, so we can have a problem where the text is interpreted
						// as an HTML tag. So this line encodes the title of the question.
						question.title = $("<div/>").text(question.title).html();
					
						$.each(question.tags, function(index, tag) {
							if(tags[tag]) {
								tags[tag].questions.push(question);
							} else {
								tags[tag] = { "questions": [ question ] };
							}
						});
					
					});

					allFavorites = data;
					stackunderflow.render.questions(data, '#allFavorites');
					
					//Show a folder for each tag with the right questions in it
					$.each(tags, function(tagName, tagQuestions) {
						var tagContainerHtml = '<li class="ui-widget-content"><span class="folderName">'+tagName+'</span> <a class="expand">+</a><div id="'+tagName+'_tagContainer"class="tagQuestions" style="display: none;"></div><div style="clear:both;"></div></li>';
						
						$('#folders').append(tagContainerHtml);
						
						stackunderflow.render.questions(tagQuestions, '#'+tagName+'_tagContainer');
					});
					
				}
			);
		}
		
		function performSearch() {
			var searchInput = $('#searchInput').val();
			$('#searchResults').html(''); //Reset search results;
		
			if(allFavorites.questions) {
				var searchResults = { 'questions': [] };
				var patt = RegExp(searchInput,'i');
				var alreadyFound = {};
				
				$.each(allFavorites.questions, function(index, question) {
					if(!alreadyFound[question.question_id]) {
						if(question.title.search(patt) != -1) {
							searchResults.questions.push(question);
							alreadyFound[question.question_id] = 'found';
						} else if(question.owner && question.owner.display_name.search(patt) != -1) {
							searchResults.questions.push(question);
							alreadyFound[question.question_id] = 'found';
						} else {
							$.each(question.tags, function(index, tag) {
								if(tag.search(patt) != -1) {
									searchResults.questions.push(question);
									alreadyFound[question.question_id] = 'found';
									return;
								}
							});
						}
					}
				});
			
				stackunderflow.render.questions(searchResults, '#searchResults');
			}
		}
		
		</script>
		
		<style>
			#folders .ui-selecting { background: #FECA40; }
			#folders .ui-selected { background: #F39814; color: white; }
			#folders { list-style-type: none; margin: 0; padding: 0; }
			#folders li { margin: 3px; padding: 0.4em; }
			#folders li .folderName { font-size: 1.4em; }
			#folders li .expand { color: green; }
			#folders li .red { color: red; }
			#userIDForm { padding-top: 5px; }
			#userFlair { margin-left: 10px; }
		</style>
		
	</head>
	<body>
		<img src="title.png" alt="StackOverflow Favorites Organizer"/>
	
		<form id="userIDForm" class ="ui-widget">
			<span style="position: relative; top: -8px;">
				User ID: <input type="text" id="userID" />
				<input type="submit" value="Submit" />
			</span>
			
			<span id="userFlair">
		
			</span>
		</form> 		
		
		<div id="tabs">
			<ul>
				<li><a href="#tabs-1">All Favorites</a></li>
				<li><a href="#tabs-2">Organized into Tags</a></li>
				<li><a href="#tabs-3">Search</a></li>
			</ul>
			<div id="tabs-1">
				<div id="allFavorites" style="height: auto;"></div>
				<div style="clear: both;"></div>
			</div>
			<div id="tabs-2">
				<ul id="folders">
				
				</ul>
			</div>
			<div id="tabs-3">
				<form id="searchForm">
					<input type="text" id="searchInput" />
					<input type="submit" value="Search" />
				</form>
				<div id="searchResults">
				
				</div>
				<div style="clear: both;"></div>
			</div>
		</div>
		
	</body>
</html>


